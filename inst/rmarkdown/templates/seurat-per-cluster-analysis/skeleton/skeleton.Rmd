---
## Updated 2019-04-17.
params:
  title: "Per Cluster Analysis"
  
  ## Use Seurat object file as input.
  seurat_file: "data/YYYY-MM-DD/seurat.rds"

title: "`r params$title`"
author: "`r getOption('author')`"
date: "`r Sys.Date()`"
bibliography: bibliography.bib
---

```{r setup, cache=FALSE, message=FALSE}
library(pointillism)
prepareTemplate(package = "pointillism")
source("_setup.R")
```

```{r header, child="_header.Rmd"}
```

# Load Seurat object

```{r load-seurat}
stopifnot(file.exists(params$seurat_file))
if (fileExt(params$seurat_file) == "rds") {
    seurat <- readRDS(file = params$seurat_file)
    name <- basenameSansExt(params$seurat_file)
} else if (fileExt(params$seurat_file) == "rda") {
    name <- load(file = params$seurat_file)
    seurat <- get(x = name, inherits = FALSE)
}
stopifnot(
    is(seurat, "Seurat"),
    is.character(name)
)
invisible(validObject(seurat))
print(seurat)
```

```{r metadata}
idents <- levels(seurat@ident)
interesting_groups <- interestingGroups(seurat)
```

# tSNE (all clusters) {.tabset}

```{r plot-tsne-all-clusters, results="asis"}
groups <- unique(c("ident", "sampleName", interesting_groups))
invisible(lapply(groups, function(group) {
    markdownHeader(group, level = 2, asis = TRUE)
    plotTSNE(seurat, interestingGroups = group) %>%
        show()
}))
rm(groups)
```

# tSNE per cluster {.tabset}

```{r plot-tsne-per-cluster, results="asis"}
groups <- unique(c("sampleName", interesting_groups))
invisible(lapply(idents, function(ident) {
    subset <- SubsetData(seurat, ident.use = ident)
    markdownHeader(ident, level = 2, asis = TRUE, tabset = TRUE)
    invisible(lapply(groups, function(group) {
        markdownHeader(group, level = 3, asis = TRUE)
        plotTSNE(subset, interestingGroups = group) %>% show()
    }))
}))
rm(groups)
```

# Cell counts per cluster {.tabset}

```{r cell-counts-per-cluster, results="asis"}
invisible(lapply(idents, function(ident) {
    subset <- SubsetData(seurat, ident.use = ident)
    markdownHeader(ident, level = 2, asis = TRUE, tabset = TRUE)
    master <- subset@meta.data %>%
        uniteInterestingGroups(interestingGroups) %>%
        select(sampleName, interestingGroups)
    sampleStats <- master %>%
        arrange(sampleName) %>%
        group_by(sampleName) %>%
        summarize(count = n()) %>%
        mutate(pct = count / sum(count))
    intgroupStats <- master %>%
        arrange(interestingGroups) %>%
        group_by(interestingGroups) %>%
        summarize(count = n()) %>%
        mutate(pct = count / sum(count))
    kable(sampleStats, digits = 2) %>% show()
    kable(intgroupStats, digits = 2) %>% show()
}))
```

# Seurat parameters {.tabset}

```{r seurat-diagnostics}
markdownHeader("PrintPCAParams", level = 2)
PrintPCAParams(seurat)

markdownHeader("PrintFindClustersParams", level = 2)
PrintFindClustersParams(seurat)

markdownHeader("PrintTSNEParams", level = 2)
PrintTSNEParams(seurat)

markdownHeader("PrintSNNParams", level = 2)
PrintSNNParams(seurat)
```

```{r footer, child="_footer.Rmd"}
```
